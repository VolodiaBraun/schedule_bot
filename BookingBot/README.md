# Универсальный Telegram-бот для записи "без окон"

## Описание

Универсальный Telegram-бот, обеспечивающий удобное и гибкое бронирование времени сеансов с возможностью создания отдельных организаций (психологи, автомойки, врачи, парикмахерские и т.д.) с учетом специфических требований: избегания "окон" (незанятых периодов между сеансами) в расписании и ограничения максимального количества сеансов в день.

## Особенности

- **Мульти-организационная архитектура**: каждый пользователь может создать свою организацию с отдельным расписанием и уникальным кодом для клиентов
- **Алгоритм "без окон"**: исключает ситуацию, при которой между двумя занятыми слотами остается небольшой промежуток времени, который не может быть использован для новой записи
- **Административная панель**: управление расписанием, записями, настройками для каждой организации
- **Удобный интерфейс**: календарь и кнопки для выбора даты и времени
- **Ограничение сеансов**: возможность установить максимальное количество сеансов в день
- **Настройка профиля организации**: название, адрес, контактная информация, описание
- **Уникальные коды организаций**: клиенты записываются по уникальному коду, который дает администратор

## Архитектура

### Основные компоненты:
- `main.py`: точка входа в приложение
- `bot/`: основная логика бота
- `database/`: модели и работа с базой данных
- `handlers/`: обработка команд и callback'ов
- `keyboards/`: inline-клавиатуры
- `utils/`: вспомогательные функции, включая алгоритм "без окон" и FSM состояния

### Технологии:
- Python 3.8+
- aiogram 3.x (фреймворк для Telegram Bot API)
- SQLAlchemy 2.x (работа с базой данных)
- PostgreSQL (или SQLite для тестирования)

## Установка и запуск

### На Windows:

1. Установите Microsoft C++ Build Tools:
   - Скачайте и установите "Build Tools for Visual Studio" с официального сайта Microsoft
   - Убедитесь, что в процессе установки выбраны компоненты для C++

2. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   venv\Scripts\activate
   ```

3. Установите зависимости:
   ```bash
   pip install aiogram==3.4.1 SQLAlchemy==1.4.46 python-dotenv==1.0.0 aiofiles==23.2.1 magic-filter==1.0.12 typing-extensions==4.7.1
   ```

4. Создайте копию файла `.env.example` и назовите его `.env`, затем укажите в нем токен вашего бота:
   ```
   BOT_TOKEN=ваш_токен_здесь
   DATABASE_URL=sqlite+aiosqlite:///./booking_bot.db
   ```

5. Запустите инициализацию базы данных:
   ```bash
   python setup_db.py
   ```

6. Запустите бота:
   ```bash
   python main.py
   ```

### Альтернативный способ для Windows (если возникают проблемы с установкой):

1. Используйте Anaconda или Miniconda
2. Создайте новое окружение:
   ```bash
   conda create -n booking_bot python=3.9
   conda activate booking_bot
   ```

3. Установите зависимости

## Алгоритм "без окон"

Слот отображается как доступный, только если его выбор не может привести к формированию комбинации с окном в пределах лимита сеансов в день.

### Пример работы:
- Админ указал: вторник 12.11.25 с 16:00 до 20:00, максимум 3 записи
- После записи первого клиента на 17:00:
  - Для второго клиента доступны: 16:00 и 18:00
  - Слот 19:00 скрывается, потому что его выбор в сочетании с 17:00 может привести к комбинации [16:00, 17:00, 19:00] с "окном" (18:00 между 17:00 и 19:00)

## Команды бота

### Для всех пользователей:
- `/start` - начать взаимодействие с ботом
- `/code` - записаться по уникальному коду организации
- `/book` - записаться (после выбора организации)
- `/my_bookings` - посмотреть свои записи
- `/help` - список команд

### Для администраторов организаций:
- `/setup` - создать профиль организации (название, адрес, контакты, описание)
- `/admin` - войти в административный режим
- `/schedule` - управление расписанием
- `/bookings` - просмотр всех записей
- `/settings` - настройки бота
- `/info` - информация о вашей организации

## Создание новой организации

1. Отправьте боту команду `/setup`
2. Следуйте инструкциям для ввода:
   - Название организации
   - Адрес
   - Контактной информации
   - Описания услуг
3. После создания вы получите уникальный код для вашей организации
4. Предоставьте этот код клиентам, чтобы они могли записаться к вам

## Запись к организации

1. Клиент использует команду `/code` и вводит уникальный код организации
2. После выбора организации клиент может использовать команду `/book` для записи
3. Клиент выбирает дату и время, учитывая алгоритм "без окон"

## Тестирование

Для тестирования мульти-организационных возможностей запустите:
```bash
python test_multi_org.py
```

## Автор

Разработано в рамках проекта BMAD Method