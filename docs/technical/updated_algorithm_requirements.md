# Алгоритм работы системы записи без "окон" - УТОЧНЕННЫЙ

## Основная концепция

Система записи без "окон" предотвращает ситуацию, при которой между двумя занятыми слотами остается небольшой промежуток времени, который не может быть использован для новой записи. Система учитывает максимальное количество сеансов в день и динамически рассчитывает доступные слоты, чтобы избежать формирования "окон" независимо от порядка выбора слотов клиентами.

## Правило отображения слотов

**Слот отображается как доступный, только если его выбор не может привести к формированию комбинации с окном в пределах лимита сеансов в день.**

## Пример работы алгоритма

Допустим, установлено расписание: вторник 12.11.25 с 16:00 до 20:00, сеанс 1 час, максимум 3 сеанса в день.

Потенциальные слоты: 16:00, 17:00, 18:00, 19:00

### Сценарий 1: Начальное состояние
- Расписание: 16:00, 17:00, 18:00, 19:00 - всего 4 возможных слота
- Максимальное количество сеансов: 3
- Занятых слотов: 0
- Все слоты доступны, т.к. любая комбинация из 3 слотов из 4 может быть проверена на отсутствие окон

Допустимые комбинации из 3 слотов:
1. 16:00, 17:00, 18:00 - без окон ✓
2. 16:00, 17:00, 19:00 - окно 18:00 между 17:00 и 19:00 ✗
3. 16:00, 18:00, 19:00 - окно 17:00 между 16:00 и 18:00 ✗
4. 17:00, 18:00, 19:00 - без окон ✓

Допустимые комбинации: [16:00, 17:00, 18:00] и [17:00, 18:00, 19:00]

Система отображает все слоты, которые могут быть частью хотя бы одной допустимой комбинации:
- 16:00 - может быть в комбинации [16:00, 17:00, 18:00] ✓
- 17:00 - может быть в обеих комбинациях ✓
- 18:00 - может быть в обеих комбинациях ✓
- 19:00 - может быть в комбинации [17:00, 18:00, 19:00] ✓

### Сценарий 2: После записи первого клиента на 17:00
- Занятые слоты: [17:00]
- Оставшиеся слоты: 16:00, 18:00, 19:00
- Максимально доступно: 2 слота (осталось 2 из 3)

Анализ каждого оставшегося слота:
1. 16:00 - возможные комбинации с [17:00]: 
   - [16:00, 17:00] + 1 слот: 
     - [16:00, 17:00, 18:00] - без окон ✓
     - [16:00, 17:00, 19:00] - окно 18:00 ✗
   - Поскольку возможна допустимая комбинация, 16:00 отображается ✓

2. 18:00 - возможные комбинации с [17:00]:
   - [17:00, 18:00] + 1 слот:
     - [16:00, 17:00, 18:00] - без окон ✓
     - [17:00, 18:00, 19:00] - без окон ✓
   - Обе комбинации допустимы, 18:00 отображается ✓

3. 19:00 - возможные комбинации с [17:00]:
   - [17:00, 19:00] + 1 слот:
     - [16:00, 17:00, 19:00] - окно 18:00 между 17:00 и 19:00 ✗
     - [17:00, 18:00, 19:00] - без окон ✓
   - Поскольку возможна комбинация с окном (если третий слот будет 16:00), 19:00 НЕ отображается ✗

**Результат:** Для второго клиента отображаются только 16:00 и 18:00. Слот 19:00 скрывается, чтобы избежать возможного окна при комбинации [16:00, 17:00, 19:00].

### Сценарий 3: Если второй клиент выбирает 18:00
- Занятые слоты: [17:00, 18:00]
- Оставшиеся слоты: 16:00, 19:00
- Максимально доступно: 1 слот (остался 1 из 3)

Анализ:
1. 16:00 - возможная комбинация: [16:00, 17:00, 18:00] - без окон ✓
2. 19:00 - возможная комбинация: [17:00, 18:00, 19:00] - без окон ✓

**Результат:** Для третьего клиента доступны оба слота: 16:00 и 19:00.

### Сценарий 4: Если третий клиент выбирает 19:00
- Занятые слоты: [17:00, 18:00, 19:00]
- Лимит достигнут (3 из 3)
- Все слоты в этот день становятся недоступны

## Алгоритм реализации

### Шаг 1: Определение текущего состояния
- Получить занятые слоты в выбранный день
- Определить максимальное количество оставшихся сеансов

### Шаг 2: Генерация всех возможных комбинаций
- Для каждого свободного слота сгенерировать все возможные комбинации с учетом уже занятых слотов и оставшегося лимита

### Шаг 3: Фильтрация комбинаций
- Проверить каждую комбинацию на наличие "окон":
  - Упорядочить слоты по времени
  - Проверить, есть ли пропущенные слоты между первым и последним занятыми слотами
  - Если есть пропущенные слоты, комбинация считается недопустимой

### Шаг 4: Определение доступных слотов
- Включить в список доступных только те слоты, которые могут быть частью хотя бы одной допустимой комбинации (без окон)
- Исключить слоты, выбор которых может привести к формированию комбинации с окном

## Особые условия

1. Если количество доступных слотов равно максимальному количеству сеансов в день, все слоты не становятся автоматически недоступны - они проверяются по алгоритму.
2. Если количество занятых слотов достигает максимального, все слоты в этот день становятся недоступны.
3. Система должна анализировать все возможные комбинации в пределах оставшегося лимита, чтобы предотвратить ситуацию с "окном".